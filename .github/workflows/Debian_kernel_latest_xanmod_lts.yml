#
# Build Debian VPS Optimized Kernel using GitHub Actions
# License: MIT
#

name: Debian VPS Optimized Kernel Build

on:
  workflow_dispatch:

env:
  UPLOAD_DIR: true
  UPLOAD_RELEASE: true
  UPLOAD_WETRANSFER: false
  WEBSSH: false
  TZ: Asia/Shanghai
  FILE_DATE: Kernel_Build_${{ github.run_id }}

jobs:
  build:
    runs-on: ubuntu-latest
    container: docker.io/qctt/kernelbuild:debian12

    steps:
    - name: Checkout repository
      uses: actions/checkout@v3

    - name: Prepare workspace
      run: |
        mkdir -p /workdir/linux-src
        cd /workdir

    - name: Download XANMOD Kernel Source
      run: |
        cd /workdir
        wget -O linux-6.12.zip https://gitlab.com/xanmod/linux/-/archive/6.12/linux-6.12.zip
        unzip linux-6.12.zip
        mv linux-6.12 /workdir/linux-src
        echo "Source ready at /workdir/linux-src"

    - name: Apply VPS optimized config
      working-directory: /workdir/linux-src
      run: |
        # 基于默认配置
        make defconfig

        # 设置 O3 优化
        export KCFLAGS="-march=x86-64-v3 -O3 -pipe -fomit-frame-pointer"
        export KCPPFLAGS="-march=x86-64-v3"

        # CPU 和性能
        scripts/config --disable GENERIC_CPU
        scripts/config --enable CC_OPTIMIZE_FOR_PERFORMANCE

        # 调度器与低延迟
        scripts/config --enable PREEMPT_VOLUNTARY
        scripts/config --enable HZ_1000
        scripts/config --enable NO_HZ_IDLE
        scripts/config --enable RCU_FAST_NO_HZ

        # 防火墙 & 网络
        scripts/config --enable NETFILTER
        scripts/config --enable IPT_CONNTRACK
        scripts/config --enable NF_CONNTRACK
        scripts/config --enable IP_NF_IPTABLES
        scripts/config --enable IP_NF_FILTER
        scripts/config --enable IP_NF_TARGET_REJECT
        scripts/config --enable IP_NF_MANGLE
        scripts/config --enable IP6_NF_FILTER
        scripts/config --enable IP6_NF_TARGET_REJECT
        scripts/config --enable NF_NAT
        scripts/config --enable NF_NAT_IPV4
        scripts/config --enable NF_NAT_IPV6
        scripts/config --enable NF_TABLES
        scripts/config --enable NF_TABLES_INET

        # 虚拟化支持
        scripts/config --enable VIRTIO
        scripts/config --enable VIRTIO_NET
        scripts/config --enable VIRTIO_PCI
        scripts/config --enable VIRTIO_BLK
        scripts/config --enable VIRTIO_BALLOON

        # 精简模块
        scripts/config --disable USB_SUPPORT
        scripts/config --disable USB
        scripts/config --disable SND
        scripts/config --disable DRM
        scripts/config --disable FB
        scripts/config --disable VGA_CONSOLE
        scripts/config --disable INPUT
        scripts/config --disable MEDIA_SUPPORT
        scripts/config --disable VIDEO_DEV

        # 文件系统
        scripts/config --enable EXT4_FS
        scripts/config --enable TMPFS
        scripts/config --enable PROC_FS
        scripts/config --enable SYSFS
        scripts/config --disable BTRFS_FS
        scripts/config --disable XFS_FS
        scripts/config --disable F2FS_FS
        scripts/config --disable JFS_FS
        scripts/config --disable NILFS2_FS

        # 调试信息关闭
        scripts/config --disable DEBUG_INFO
        scripts/config --disable DEBUG_KERNEL
        scripts/config --disable KALLSYMS
        scripts/config --disable MODULE_SIG
        scripts/config --disable SYSTEM_TRUSTED_KEYS
        scripts/config --disable SYSTEM_REVOCATION_KEYS

        make oldconfig

    - name: Compile Kernel
      working-directory: /workdir/linux-src
      run: |
        export KCFLAGS="-march=x86-64-v3 -O3 -pipe -fomit-frame-pointer"
        export KCPPFLAGS="-march=x86-64-v3"
        echo "$(nproc) threads compiling kernel..."
        sudo time make -j$(nproc) deb-pkg

    - name: Check disk usage
      run: df -hT

    - name: Upload build artifacts
      uses: actions/upload-artifact@v3
      if: env.UPLOAD_DIR == 'true'
      with:
        name: ${{ env.FILE_DATE }}
        path: /workdir/*.deb

    - name: Generate release tag
      id: tag
      run: |
        echo "::set-output name=release_tag::Debian_Kernel_VPS_$(date +'%Y%m%d%H%M')"
        touch release.txt
        echo "VPS optimized kernel build" > release.txt
        echo "::set-output name=status::success"

    - name: Upload to GitHub Release
      uses: softprops/action-gh-release@v1
      if: steps.tag.outputs.status == 'success'
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
      with:
        tag_name: ${{ steps.tag.outputs.release_tag }}
        body_path: release.txt
        files: /workdir/*.deb
